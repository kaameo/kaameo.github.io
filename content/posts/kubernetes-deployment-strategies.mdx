---
title: "Kubernetes ë°°í¬ ì „ëµ: ì•ˆì „í•˜ê³  íš¨ìœ¨ì ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—…ë°ì´íŠ¸"
date: "2024-01-28"
excerpt: "Rolling Update, Blue-Green, Canary ë“± Kubernetesì˜ ë‹¤ì–‘í•œ ë°°í¬ ì „ëµì„ ì‹¤ìŠµê³¼ í•¨ê»˜ ì•Œì•„ë´…ë‹ˆë‹¤."
category: "DevOps"
tags: ["Kubernetes", "K8s", "ë°°í¬ ì „ëµ", "DevOps", "CI/CD"]
author: "Kaameo"
---

í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì•ˆì „í•˜ê²Œ ì—…ë°ì´íŠ¸í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. 
KubernetesëŠ” ë‹¤ì–‘í•œ ë°°í¬ ì „ëµì„ ì§€ì›í•˜ì—¬ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ì´ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

## ë°°í¬ ì „ëµì˜ ì¤‘ìš”ì„±

### ì™œ ë°°í¬ ì „ëµì´ í•„ìš”í•œê°€?
- **ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤**: ì‚¬ìš©ì ê²½í—˜ ì €í•˜ ë°©ì§€
- **ìœ„í—˜ ìµœì†Œí™”**: ë¬¸ì œ ë°œìƒ ì‹œ ë¹ ë¥¸ ë¡¤ë°±
- **ì ì§„ì  ë¡¤ì•„ì›ƒ**: ì¼ë¶€ ì‚¬ìš©ìë¡œ í…ŒìŠ¤íŠ¸ í›„ ì „ì²´ ë°°í¬
- **ìë™í™”**: ìˆ˜ë™ ì‘ì—… ìµœì†Œí™”ë¡œ íœ´ë¨¼ ì—ëŸ¬ ë°©ì§€

## 1. Rolling Update (ë¡¤ë§ ì—…ë°ì´íŠ¸)

ê°€ì¥ ê¸°ë³¸ì ì´ê³  ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” ë°°í¬ ì „ëµì…ë‹ˆë‹¤.

### ì‘ë™ ë°©ì‹
```
v1 â†’ v1 â†’ v1 â†’ v1  (í˜„ì¬ ë²„ì „)
â†“
v2 â†’ v1 â†’ v1 â†’ v1  (ì²« ë²ˆì§¸ Pod ì—…ë°ì´íŠ¸)
â†“
v2 â†’ v2 â†’ v1 â†’ v1  (ë‘ ë²ˆì§¸ Pod ì—…ë°ì´íŠ¸)
â†“
v2 â†’ v2 â†’ v2 â†’ v1  (ì„¸ ë²ˆì§¸ Pod ì—…ë°ì´íŠ¸)
â†“
v2 â†’ v2 â†’ v2 â†’ v2  (ëª¨ë“  Pod ì—…ë°ì´íŠ¸ ì™„ë£Œ)
```

### êµ¬í˜„ ì˜ˆì œ

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
spec:
  replicas: 4
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # ë™ì‹œì— ìƒì„±í•  ìˆ˜ ìˆëŠ” ì¶”ê°€ Pod ìˆ˜
      maxUnavailable: 1  # ë™ì‹œì— ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ Pod ìˆ˜
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: web-app
        image: myapp:v1
        ports:
        - containerPort: 80
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
```

### ì—…ë°ì´íŠ¸ ì‹¤í–‰
```bash
# ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
kubectl set image deployment/web-app web-app=myapp:v2

# ë¡¤ì•„ì›ƒ ìƒíƒœ í™•ì¸
kubectl rollout status deployment/web-app

# ë¡¤ì•„ì›ƒ íˆìŠ¤í† ë¦¬ í™•ì¸
kubectl rollout history deployment/web-app

# ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
kubectl rollout undo deployment/web-app
```

### ì¥ë‹¨ì 
**ì¥ì **
- Kubernetes ê¸°ë³¸ ì§€ì›
- ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì 
- ê°„ë‹¨í•œ ì„¤ì •

**ë‹¨ì **
- ì¼ì‹œì ìœ¼ë¡œ v1ê³¼ v2ê°€ ê³µì¡´
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ì£¼ì˜ í•„ìš”

## 2. Blue-Green ë°°í¬

ë‘ ê°œì˜ ë™ì¼í•œ í™˜ê²½ì„ ì‚¬ìš©í•˜ì—¬ ìˆœê°„ì ìœ¼ë¡œ ì „í™˜í•˜ëŠ” ì „ëµì…ë‹ˆë‹¤.

### ì‘ë™ ë°©ì‹
```
[Blue (v1) - Active]  â†â”€â”€ Load Balancer â†â”€â”€ Users
[Green (v2) - Standby]

â†“ (í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ì „í™˜)

[Blue (v1) - Standby]
[Green (v2) - Active] â†â”€â”€ Load Balancer â†â”€â”€ Users
```

### êµ¬í˜„ ì˜ˆì œ

```yaml
# blue-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app-blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web-app
      version: blue
  template:
    metadata:
      labels:
        app: web-app
        version: blue
    spec:
      containers:
      - name: web-app
        image: myapp:v1
        ports:
        - containerPort: 80

---
# green-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app-green
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web-app
      version: green
  template:
    metadata:
      labels:
        app: web-app
        version: green
    spec:
      containers:
      - name: web-app
        image: myapp:v2
        ports:
        - containerPort: 80

---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: web-app-service
spec:
  selector:
    app: web-app
    version: blue  # í˜„ì¬ëŠ” Blueë¥¼ ê°€ë¦¬í‚´
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

### Blue-Green ì „í™˜ ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# blue-green-switch.sh

CURRENT_VERSION=$(kubectl get service web-app-service -o jsonpath='{.spec.selector.version}')
echo "í˜„ì¬ í™œì„± ë²„ì „: $CURRENT_VERSION"

if [ "$CURRENT_VERSION" = "blue" ]; then
    NEW_VERSION="green"
else
    NEW_VERSION="blue"
fi

echo "ìƒˆ ë²„ì „ìœ¼ë¡œ ì „í™˜: $NEW_VERSION"

# Service selector ì—…ë°ì´íŠ¸
kubectl patch service web-app-service -p '{"spec":{"selector":{"version":"'$NEW_VERSION'"}}}'

echo "ì „í™˜ ì™„ë£Œ!"
```

### ì¥ë‹¨ì 
**ì¥ì **
- ì¦‰ì‹œ ë¡¤ë°± ê°€ëŠ¥
- í…ŒìŠ¤íŠ¸ í™˜ê²½ê³¼ í”„ë¡œë•ì…˜ í™˜ê²½ ë™ì¼
- v1ê³¼ v2 íŠ¸ë˜í”½ í˜¼ì¬ ì—†ìŒ

**ë‹¨ì **
- ë¦¬ì†ŒìŠ¤ 2ë°° í•„ìš”
- ìƒíƒœë¥¼ ê°€ì§„ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ë³µì¡
- ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¡°ì • í•„ìš”

## 3. Canary ë°°í¬

ìƒˆ ë²„ì „ì„ ì¼ë¶€ ì‚¬ìš©ìì—ê²Œë§Œ ë…¸ì¶œí•˜ì—¬ ì ì§„ì ìœ¼ë¡œ ë°°í¬í•˜ëŠ” ì „ëµì…ë‹ˆë‹¤.

### ì‘ë™ ë°©ì‹
```
95% íŠ¸ë˜í”½ â†’ v1 (Stable)
5% íŠ¸ë˜í”½  â†’ v2 (Canary)

â†“ (ëª¨ë‹ˆí„°ë§ í›„ ë¬¸ì œ ì—†ìœ¼ë©´)

50% íŠ¸ë˜í”½ â†’ v1
50% íŠ¸ë˜í”½ â†’ v2

â†“ (ìµœì¢… ì „í™˜)

100% íŠ¸ë˜í”½ â†’ v2
```

### Nginx Ingressë¥¼ ì‚¬ìš©í•œ Canary ë°°í¬

```yaml
# stable-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app-stable
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web-app
      version: stable
  template:
    metadata:
      labels:
        app: web-app
        version: stable
    spec:
      containers:
      - name: web-app
        image: myapp:v1
        ports:
        - containerPort: 80

---
# canary-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: web-app
      version: canary
  template:
    metadata:
      labels:
        app: web-app
        version: canary
    spec:
      containers:
      - name: web-app
        image: myapp:v2
        ports:
        - containerPort: 80

---
# stable-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: web-app-stable
spec:
  selector:
    app: web-app
    version: stable
  ports:
  - port: 80
    targetPort: 80

---
# canary-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: web-app-canary
spec:
  selector:
    app: web-app
    version: canary
  ports:
  - port: 80
    targetPort: 80

---
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-app-ingress
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"  # 10% íŠ¸ë˜í”½
spec:
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-app-canary
            port:
              number: 80
```

### Flaggerë¥¼ ì‚¬ìš©í•œ ìë™í™”ëœ Canary ë°°í¬

```yaml
# flagger-canary.yaml
apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: web-app
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: web-app
  service:
    port: 80
  analysis:
    interval: 1m
    threshold: 10
    maxWeight: 50
    stepWeight: 5
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
  webhooks:
    - name: acceptance-test
      type: pre-rollout
      url: http://flagger-loadtester.test/
      timeout: 30s
      metadata:
        type: bash
        cmd: "curl -sd 'test' http://web-app-canary.test/health"
```

## 4. A/B Testing ë°°í¬

ì‚¬ìš©ìë¥¼ íŠ¹ì • ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜í•˜ì—¬ ë‹¤ë¥¸ ë²„ì „ì„ ì œê³µí•˜ëŠ” ì „ëµì…ë‹ˆë‹¤.

### Istioë¥¼ ì‚¬ìš©í•œ A/B Testing

```yaml
# virtual-service.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: web-app-vs
spec:
  hosts:
  - web-app
  http:
  - match:
    - headers:
        user-group:
          exact: beta-testers
    route:
    - destination:
        host: web-app
        subset: v2
      weight: 100
  - route:
    - destination:
        host: web-app
        subset: v1
      weight: 100

---
# destination-rule.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: web-app-dr
spec:
  host: web-app
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

## 5. Shadow (ë¯¸ëŸ¬ë§) ë°°í¬

ì‹¤ì œ íŠ¸ë˜í”½ì„ ìƒˆ ë²„ì „ì— ë³µì œí•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ëŠ” ì „ëµì…ë‹ˆë‹¤.

```yaml
# istio-mirror.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: web-app-vs
spec:
  hosts:
  - web-app
  http:
  - route:
    - destination:
        host: web-app
        subset: v1
      weight: 100
    mirror:
      host: web-app
      subset: v2
    mirrorPercentage:
      value: 100.0
```

## ë°°í¬ ì „ëµ ì„ íƒ ê°€ì´ë“œ

### ìƒí™©ë³„ ì¶”ì²œ ì „ëµ

| ìƒí™© | ì¶”ì²œ ì „ëµ | ì´ìœ  |
|-----|----------|------|
| ì¼ë°˜ì ì¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ | Rolling Update | ê°„ë‹¨í•˜ê³  ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì  |
| ì¤‘ìš”í•œ í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ | Blue-Green | ì¦‰ì‹œ ë¡¤ë°± ê°€ëŠ¥ |
| ëŒ€ê·œëª¨ ì‚¬ìš©ì ì„œë¹„ìŠ¤ | Canary | ìœ„í—˜ ìµœì†Œí™”, ì ì§„ì  ë°°í¬ |
| ê¸°ëŠ¥ ì‹¤í—˜ | A/B Testing | ì‚¬ìš©ì ê·¸ë£¹ë³„ í…ŒìŠ¤íŠ¸ |
| ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ í•„ìš” | Shadow | ì‹¤ì œ íŠ¸ë˜í”½ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ |

## ëª¨ë‹ˆí„°ë§ê³¼ ìë™í™”

### Prometheus + Grafana ëª¨ë‹ˆí„°ë§
```yaml
# servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: web-app-metrics
spec:
  selector:
    matchLabels:
      app: web-app
  endpoints:
  - port: metrics
    interval: 30s
    path: /metrics
```

### ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# deploy.sh

VERSION=$1
DEPLOYMENT="web-app"
NAMESPACE="production"

# í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
check_health() {
    kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE
    if [ $? -eq 0 ]; then
        echo "âœ… ë°°í¬ ì„±ê³µ!"
    else
        echo "âŒ ë°°í¬ ì‹¤íŒ¨! ë¡¤ë°± ì¤‘..."
        kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
        exit 1
    fi
}

# ë°°í¬ ì‹¤í–‰
echo "ğŸš€ ë²„ì „ $VERSION ë°°í¬ ì‹œì‘..."
kubectl set image deployment/$DEPLOYMENT $DEPLOYMENT=myapp:$VERSION -n $NAMESPACE

# í—¬ìŠ¤ì²´í¬
check_health

# ë©”íŠ¸ë¦­ í™•ì¸
echo "ğŸ“Š ë©”íŠ¸ë¦­ í™•ì¸ ì¤‘..."
sleep 30

# ì—ëŸ¬ìœ¨ ì²´í¬ (ì˜ˆì‹œ)
ERROR_RATE=$(kubectl exec -n monitoring prometheus-0 -- promtool query instant \
  'rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])' | \
  grep -oP '[\d.]+')

if (( $(echo "$ERROR_RATE > 0.01" | bc -l) )); then
    echo "âŒ ì—ëŸ¬ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤ ($ERROR_RATE). ë¡¤ë°± ì¤‘..."
    kubectl rollout undo deployment/$DEPLOYMENT -n $NAMESPACE
    exit 1
fi

echo "âœ… ë°°í¬ ì™„ë£Œ!"
```

## ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. Health Check ì„¤ì •
```yaml
readinessProbe:
  httpGet:
    path: /health
    port: 80
  initialDelaySeconds: 10
  periodSeconds: 5
  
livenessProbe:
  httpGet:
    path: /health
    port: 80
  initialDelaySeconds: 30
  periodSeconds: 10
```

### 2. ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì •
```yaml
resources:
  requests:
    memory: "256Mi"
    cpu: "250m"
  limits:
    memory: "512Mi"
    cpu: "500m"
```

### 3. PodDisruptionBudget ì„¤ì •
```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: web-app-pdb
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: web-app
```

## ë§ˆë¬´ë¦¬

ê° ë°°í¬ ì „ëµì€ ê³ ìœ í•œ ì¥ë‹¨ì ì´ ìˆìœ¼ë©°, ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ íŠ¹ì„±ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ìš”êµ¬ì‚¬í•­ì— ë”°ë¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. 
Rolling Updateë¡œ ì‹œì‘í•˜ì—¬ ì ì°¨ ë³µì¡í•œ ì „ëµìœ¼ë¡œ ë°œì „ì‹œì¼œ ë‚˜ê°€ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Kubernetesì˜ Service Meshì™€ Istioë¥¼ í™œìš©í•œ ê³ ê¸‰ íŠ¸ë˜í”½ ê´€ë¦¬ì— ëŒ€í•´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤!

## ì°¸ê³  ìë£Œ
- [Kubernetes Deployment Strategies](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy)
- [Flagger Progressive Delivery](https://flagger.app/)
- [Istio Traffic Management](https://istio.io/latest/docs/concepts/traffic-management/)
- [Nginx Ingress Canary](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#canary)